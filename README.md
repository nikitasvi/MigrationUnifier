EF Core Migration Unifier (RU)
=============================

Краткое описание
----------------

Migration Unifier — это утилита, которая объединяет несколько миграций Entity Framework Core в одну миграцию.

Утилита:

- сканирует папку с EF Core миграциями;
- вытаскивает тела методов `Up` / `Down` нужных миграций;
- генерирует новую миграцию с объединённым `Up` / `Down`;
- генерирует соответствующий `.Designer.cs` на основе последней миграции в диапазоне.

Алгоритм работы
-------------------------

1. Выбираете миграции, которые хотите склеить.

   Пример (оставляем первую и последнюю, склеиваем середину):

       20250101000000_AddUsers        (оставляем)
       20250201000000_AddOrders       (объединяем)
       20250301000000_AddInvoices     (объединяем)
       20250401000000_AddFeatures     (объединяем)
       20250501000000_AddSomething    (оставляем)

2. Откатываете базу до миграции-якоря (которая остаётся, например `AddUsers`).

3. Запускаете Migration Unifier с нужными параметрами:

   - он объединяет тела `Up` выбранных миграций в один `Up`;
   - объединяет тела `Down` в обратном порядке;
   - копирует `BuildTargetModel` из последней миграции диапазона;
   - создаёт два файла: `xxxx_ВашКласс.cs` и `xxxx_ВашКласс.Designer.cs`.

4. Удаляете старые миграции, которые были склеены.

5. Обновляете базу до комбинированной и дальше — обычным `update-database`.

Важно: такой подход безопасен для новых баз или баз, которые вы специально откатили до якорной миграции.

Использование (CLI)
-------------------

Скрипт рассчитан на запуск через exe файл, например:

    MigrationUnifier.exe --source C:\Repositories\Migrations\ --class NewMigration --namespace Contexts.Migrations --from 20250201000000_AddOrders --until 20250401000000_AddFeatures --out C:\Users\User\Desktop


Аргументы
---------

- `-s, --source <dir>` (обязательно)  
  Путь к каталогу с миграциями EF Core (`*.cs`).

- `-c, --class <name>` (обязательно)  
  Базовое имя для нового класса. Имя будет приведено к валидному идентификатору C#.

- `-n, --namespace <ns>` (обязательно)  
  Namespace для итоговой миграции.

- `-f, --from <fileName>` (опция)  
  Название миграции “от” (включительно).

- `-u, --until <fileName>` (опция)  
  Название миграции “до” (включительно). Также yyyyMMddHHmmss используется как подсказка при генерации нового `MigrationId`.

- `-o, --out <path>` (опция)  
  Путь вывода:
  - если это каталог — оба файла (`.cs` и `.Designer.cs`) будут созданы там;
  - если это `.cs`-файл — основной файл будет создан по этому пути, а `.Designer.cs` — рядом, с тем же базовым именем.

Пошаговый сценарий (со скриншотами)
-----------------------------------

1. Откат до якорной миграции

   Выберите миграцию, от которой будете строить новую историю, например:

       20250101000000_AddUsers  ← якорная миграция

   Откатитесь к ней:

       update-database 20250101000000_AddUsers

   При необходимости можно ориентироваться на таблицу EFMigrationsHistory.

2. Выбор миграций для объединения

3. Запуск Migration Unifier

   Пример команды:

        MigrationUnifier.exe --source C:\Repositories\Migrations\ --class NewMigration --namespace Contexts.Migrations --from 20250201000000_AddOrders --until 20250401000000_AddFeatures --out C:\Users\User\Desktop

   Утилита:

   - отсканирует файлы миграций в `--source`;
   - отфильтрует их по `from/until` (если заданы);
   - соберёт объединённые тела `Up/Down`;
   - соберёт `using`-и из соответствующих файлов;
   - сгенерирует:
     - `yyyyMMddHHmmss_FeatureXCombinedMigration.cs`
     - `yyyyMMddHHmmss_FeatureXCombinedMigration.Designer.cs`

4. Удаление старых миграций и подстановка новой

   - Удалите старые миграции, которые были объединены (например, `AddOrders`, `AddInvoices`, `AddFeatures`).
   - Оставьте:
     - якорную миграцию (`AddUsers`),
     - новую комбинированную,
     - более поздние миграции (если они есть).

5. Обновление базы по новой цепочке

   На базе, откатанной до якорной миграции, выполните:

        update-database

EF:

  1. применит объединённую миграцию (эквивалент последовательному применению нескольких старых миграций),
  2. затем применит все последующие миграции (если есть).

